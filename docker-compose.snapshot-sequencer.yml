version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 2gb
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - snapshot-sequencer

  # Flexible snapshot sequencer (reads from .env)
  sequencer-custom:
    build:
      context: .
      dockerfile: Dockerfile.snapshot-sequencer
    environment:
      - SEQUENCER_ID=${SEQUENCER_ID:-sequencer-custom}
      - P2P_PORT=${P2P_PORT:-9001}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - BOOTSTRAP_MULTIADDR=${BOOTSTRAP_MULTIADDR}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # Component toggles - READ FROM ENV
      - ENABLE_LISTENER=${ENABLE_LISTENER:-true}
      - ENABLE_DEQUEUER=${ENABLE_DEQUEUER:-true}
      - ENABLE_FINALIZER=${ENABLE_FINALIZER:-false}
      - ENABLE_CONSENSUS=${ENABLE_CONSENSUS:-false}
      # Configuration
      - DEQUEUER_WORKERS=${DEQUEUER_WORKERS:-5}
      - PRIVATE_KEY=${PRIVATE_KEY}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "${P2P_PORT:-9001}:${P2P_PORT:-9001}"
    networks:
      - snapshot-sequencer
    # No profile - run directly

  # All-in-one snapshot sequencer (all components enabled)
  sequencer-all:
    build:
      context: .
      dockerfile: Dockerfile.snapshot-sequencer
    environment:
      - SEQUENCER_ID=sequencer-all
      - P2P_PORT=9001
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - BOOTSTRAP_MULTIADDR=${BOOTSTRAP_MULTIADDR}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # Component toggles - all enabled
      - ENABLE_LISTENER=true
      - ENABLE_DEQUEUER=true
      - ENABLE_FINALIZER=true
      - ENABLE_CONSENSUS=true
      # Configuration
      - DEQUEUER_WORKERS=10
      - PRIVATE_KEY=${PRIVATE_KEY_ALL}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "9001:9001"
    networks:
      - snapshot-sequencer
    profiles:
      - all
      - sequencer

  # Listener-only instance (P2P listener component)
  listener-only:
    build:
      context: .
      dockerfile: Dockerfile.snapshot-sequencer
    environment:
      - SEQUENCER_ID=listener-1
      - P2P_PORT=9100
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - BOOTSTRAP_MULTIADDR=${BOOTSTRAP_MULTIADDR}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # Component toggles - only listener
      - ENABLE_LISTENER=true
      - ENABLE_DEQUEUER=false
      - ENABLE_FINALIZER=false
      - ENABLE_CONSENSUS=false
      - PRIVATE_KEY=${PRIVATE_KEY_LISTENER}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "9100:9100"
    networks:
      - snapshot-sequencer
    profiles:
      - distributed
      - listener

  # Dequeuer-only instances (worker pool)
  dequeuer-1:
    build:
      context: .
      dockerfile: Dockerfile.snapshot-sequencer
    environment:
      - SEQUENCER_ID=dequeuer-1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # Component toggles - only dequeuer
      - ENABLE_LISTENER=false
      - ENABLE_DEQUEUER=true
      - ENABLE_FINALIZER=false
      - ENABLE_CONSENSUS=false
      - DEQUEUER_WORKERS=10
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - snapshot-sequencer
    profiles:
      - distributed
      - dequeuer
    deploy:
      replicas: ${DEQUEUER_REPLICAS:-3}

  # Finalizer-only instances
  finalizer-1:
    build:
      context: .
      dockerfile: Dockerfile.snapshot-sequencer
    environment:
      - SEQUENCER_ID=finalizer-1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # Component toggles - only finalizer
      - ENABLE_LISTENER=false
      - ENABLE_DEQUEUER=false
      - ENABLE_FINALIZER=true
      - ENABLE_CONSENSUS=false
      - IPFS_HOST=${IPFS_HOST:-ipfs:5001}
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-ipfs}
      - DA_PROVIDER=${DA_PROVIDER:-none}
      - RPC_URL=${RPC_URL}
      - PRIVATE_KEY=${PRIVATE_KEY_FINALIZER}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - snapshot-sequencer
    profiles:
      - distributed
      - finalizer
    deploy:
      replicas: ${FINALIZER_REPLICAS:-2}

  # IPFS node (optional, for finalizer)
  ipfs:
    image: ipfs/go-ipfs:latest
    ports:
      - "5001:5001"
      - "8080:8080"
    volumes:
      - ipfs-data:/data/ipfs
    networks:
      - snapshot-sequencer
    profiles:
      - storage
      - distributed

  # Monitoring stack (optional)
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - snapshot-sequencer
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - snapshot-sequencer
    profiles:
      - monitoring

volumes:
  redis-data:
  ipfs-data:
  prometheus-data:
  grafana-data:

networks:
  snapshot-sequencer:
    driver: bridge