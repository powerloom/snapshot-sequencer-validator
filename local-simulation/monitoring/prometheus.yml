# Prometheus configuration for P2P sequencer network monitoring

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'p2p-sequencer-simulation'
    environment: 'local-test'

# Rule files for alerting
rule_files:
  - "alert_rules.yml"

# Scrape configuration
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 15s
    metrics_path: /metrics

  # Docker container metrics via cAdvisor
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 10s
    metrics_path: /metrics

  # Node exporter for host metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 15s
    metrics_path: /metrics

  # P2P Bootstrap Node
  - job_name: 'p2p-bootstrap'
    static_configs:
      - targets: ['p2p-bootstrap:9100']
    scrape_interval: 10s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'bootstrap-node'
      - source_labels: []
        target_label: service_type  
        replacement: 'bootstrap'

  # P2P Sequencer Nodes
  - job_name: 'p2p-sequencers'
    static_configs:
      - targets: 
        - 'p2p-sequencer-1:8081'
        - 'p2p-sequencer-2:8081' 
        - 'p2p-sequencer-3:8081'
    scrape_interval: 10s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        regex: 'p2p-sequencer-([0-9]+):.*'
        target_label: sequencer_id
        replacement: '${1}'
      - source_labels: []
        target_label: service_type
        replacement: 'sequencer'

  # P2P Debugger
  - job_name: 'p2p-debugger'
    static_configs:
      - targets: ['p2p-debugger:8001']
    scrape_interval: 10s  
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'debugger-node'
      - source_labels: []
        target_label: service_type
        replacement: 'debugger'

  # Docker daemon metrics (if available)
  - job_name: 'docker-daemon'
    static_configs:
      - targets: ['host.docker.internal:9323']
    scrape_interval: 30s
    metrics_path: /metrics

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Storage configuration
storage:
  tsdb:
    path: /prometheus/data
    retention.time: 7d
    retention.size: 1GB

# Recording rules for aggregation
recording_rules:
  - name: p2p_network_aggregations
    interval: 30s
    rules:
      - record: p2p:peer_count:total
        expr: sum(p2p_peer_count) by (job)
      
      - record: p2p:message_rate:5m
        expr: rate(p2p_messages_sent_total[5m])
      
      - record: p2p:batch_finalization_rate:5m
        expr: rate(p2p_batches_finalized_total[5m])
      
      - record: p2p:network_health:ratio
        expr: up / on() group_left count(up)

# Web console and API configuration  
web:
  console:
    templates: /etc/prometheus/consoles
    libraries: /etc/prometheus/console_libraries
  enable_lifecycle: true
  enable_admin_api: true